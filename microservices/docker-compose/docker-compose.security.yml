# ============================================================================
# MongoDB Security Docker Compose Extension
# This file adds TLS and encryption configurations to MongoDB instances
# 
# Usage: 
#   docker-compose -f docker-compose.yml -f docker-compose.security.yml up -d
# ============================================================================

services:
  # ==========================================================================
  # MongoDB Services with TLS Configuration
  # ==========================================================================
  
  gateway-mongodb:
    volumes:
      - gateway-mongodb-data:/data/db
      - ./mongodb-security/certs/gateway-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod 
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  userservice-mongodb:
    volumes:
      - userservice-mongodb-data:/data/db
      - ./mongodb-security/certs/userservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  notificationservice-mongodb:
    volumes:
      - notificationservice-mongodb-data:/data/db
      - ./mongodb-security/certs/notificationservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  stockservice-mongodb:
    volumes:
      - stockservice-mongodb-data:/data/db
      - ./mongodb-security/certs/stockservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  newsservice-mongodb:
    volumes:
      - newsservice-mongodb-data:/data/db
      - ./mongodb-security/certs/newsservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  crawlservice-mongodb:
    volumes:
      - crawlservice-mongodb-data:/data/db
      - ./mongodb-security/certs/crawlservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  aitoolsservice-mongodb:
    volumes:
      - aitoolsservice-mongodb-data:/data/db
      - ./mongodb-security/certs/aitoolsservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsCAFile=/etc/ssl/ca.crt
        - --eval
        - "db.adminCommand('ping')"

  # ==========================================================================
  # Java Services with TLS and Encryption Configuration
  # ==========================================================================
  
  gateway:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${GATEWAY_MONGODB_USER}:${GATEWAY_MONGODB_PASSWORD}@gateway-mongodb:27017/gateway?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/gateway-client.pem:/etc/ssl/client.pem:ro

  userservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${USERSERVICE_MONGODB_USER}:${USERSERVICE_MONGODB_PASSWORD}@userservice-mongodb:27017/userservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY}
      - ENCRYPTION_SALT=${ENCRYPTION_SALT:-StockAppUserServiceSalt2024}
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/userservice-client.pem:/etc/ssl/client.pem:ro

  notificationservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${NOTIFICATIONSERVICE_MONGODB_USER}:${NOTIFICATIONSERVICE_MONGODB_PASSWORD}@notificationservice-mongodb:27017/notificationservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
      - ENCRYPTION_MASTER_KEY=${ENCRYPTION_MASTER_KEY}
      - ENCRYPTION_SALT=${ENCRYPTION_SALT:-StockAppNotificationServiceSalt2024}
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/notificationservice-client.pem:/etc/ssl/client.pem:ro

  stockservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/stockservice-client.pem:/etc/ssl/client.pem:ro

  newsservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${NEWSSERVICE_MONGODB_USER}:${NEWSSERVICE_MONGODB_PASSWORD}@newsservice-mongodb:27017/newsservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/newsservice-client.pem:/etc/ssl/client.pem:ro

  crawlservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${CRAWLSERVICE_MONGODB_USER}:${CRAWLSERVICE_MONGODB_PASSWORD}@crawlservice-mongodb:27017/crawlservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/crawlservice-client.pem:/etc/ssl/client.pem:ro

  aitoolsservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${AITOOLSSERVICE_MONGODB_USER:-admin}:${AITOOLSSERVICE_MONGODB_PASSWORD:-admin}@aitoolsservice-mongodb:27017/aitoolsservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
      - ./mongodb-security/certs/aitoolsservice-client.pem:/etc/ssl/client.pem:ro

  aiservice:
    environment:
      - MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin&tls=true&tlsCAFile=/etc/ssl/ca.crt
    volumes:
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro

# ==========================================================================
# Named Volumes for Data Persistence
# These volumes store encrypted MongoDB data
# ==========================================================================
volumes:
  gateway-mongodb-data:
    driver: local
  userservice-mongodb-data:
    driver: local
  notificationservice-mongodb-data:
    driver: local
  stockservice-mongodb-data:
    driver: local
  newsservice-mongodb-data:
    driver: local
  crawlservice-mongodb-data:
    driver: local
  aitoolsservice-mongodb-data:
    driver: local
