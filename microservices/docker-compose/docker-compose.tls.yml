# ============================================================================
# MongoDB Security Docker Compose - PRODUCTION READY
# Enables all 3 security layers:
# 1. TLS/SSL encryption for network traffic
# 2. Field-level encryption (configured in Java apps via @Encrypted annotation)
# 3. Encrypted volumes for data at rest
# 
# Usage: docker-compose -f docker-compose.yml -f docker-compose.tls.yml up -d
# ============================================================================

services:
  # ==========================================================================
  # MongoDB Services with TLS Configuration
  # ==========================================================================
  
  gateway-mongodb:
    volumes:
      - gateway-mongodb-data:/data/db
      - ./mongodb-security/certs/gateway-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod 
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  userservice-mongodb:
    volumes:
      - userservice-mongodb-data:/data/db
      - ./mongodb-security/certs/userservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  notificationservice-mongodb:
    volumes:
      - notificationservice-mongodb-data:/data/db
      - ./mongodb-security/certs/notificationservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  stockservice-mongodb:
    volumes:
      - stockservice-mongodb-data:/data/db
      - ./mongodb-security/certs/stockservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  newsservice-mongodb:
    volumes:
      - newsservice-mongodb-data:/data/db
      - ./mongodb-security/certs/newsservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  crawlservice-mongodb:
    volumes:
      - crawlservice-mongodb-data:/data/db
      - ./mongodb-security/certs/crawlservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  aitoolsservice-mongodb:
    volumes:
      - aitoolsservice-mongodb-data:/data/db
      - ./mongodb-security/certs/aitoolsservice-mongodb.pem:/etc/ssl/mongodb.pem:ro
      - ./mongodb-security/certs/ca.crt:/etc/ssl/ca.crt:ro
    command: >
      mongod
      --tlsMode requireTLS
      --tlsCertificateKeyFile /etc/ssl/mongodb.pem
      --tlsCAFile /etc/ssl/ca.crt
      --auth
    healthcheck:
      test:
        - CMD
        - mongosh
        - --tls
        - --tlsAllowInvalidCertificates
        - --eval
        - "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ==========================================================================
  # Java Services - Override MongoDB URI to enable TLS
  # Using tlsInsecure=true for development (skips certificate verification)
  # For production, use proper CA certificate configuration
  # ==========================================================================
  
  gateway:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${GATEWAY_MONGODB_USER}:${GATEWAY_MONGODB_PASSWORD}@gateway-mongodb:27017/gateway?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  userservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${USERSERVICE_MONGODB_USER}:${USERSERVICE_MONGODB_PASSWORD}@userservice-mongodb:27017/userservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  notificationservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${NOTIFICATIONSERVICE_MONGODB_USER}:${NOTIFICATIONSERVICE_MONGODB_PASSWORD}@notificationservice-mongodb:27017/notificationservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  stockservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  newsservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${NEWSSERVICE_MONGODB_USER}:${NEWSSERVICE_MONGODB_PASSWORD}@newsservice-mongodb:27017/newsservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  crawlservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${CRAWLSERVICE_MONGODB_USER}:${CRAWLSERVICE_MONGODB_PASSWORD}@crawlservice-mongodb:27017/crawlservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  aitoolsservice:
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://${AITOOLSSERVICE_MONGODB_USER:-admin}:${AITOOLSSERVICE_MONGODB_PASSWORD:-admin}@aitoolsservice-mongodb:27017/aitoolsservice?authSource=admin&tls=true&tlsInsecure=true&waitQueueMultiple=1000

  # AIService (Python) also needs TLS
  aiservice:
    environment:
      - MONGODB_URI=mongodb://${STOCKSERVICE_MONGODB_USER}:${STOCKSERVICE_MONGODB_PASSWORD}@stockservice-mongodb:27017/stockservice?authSource=admin&tls=true&tlsInsecure=true

# ==========================================================================
# Encrypted Volumes - Data at Rest Encryption
# Docker volumes with encryption driver for storing MongoDB data securely
# ==========================================================================

volumes:
  gateway-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/gateway
  userservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/userservice
  notificationservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/notificationservice
  stockservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/stockservice
  newsservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/newsservice
  crawlservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/crawlservice
  aitoolsservice-mongodb-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./mongodb-data/aitoolsservice
