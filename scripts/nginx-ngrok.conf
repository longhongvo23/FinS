# Nginx reverse proxy – single ngrok tunnel for FinS
# Port 4000 → ngrok → internet
#
# The frontend container (port 2302) already has its own nginx that
# proxies /services/* to gateway:8080 via Docker network.
#
# Routing:
#   /gateway/*   → Gateway 8080 (JHipster Admin UI + all assets)
#   /management* → Gateway 8080 (Actuator)
#   /swagger*    → Gateway 8080 (Swagger UI)
#   /v3/*        → Gateway 8080 (OpenAPI)
#   /*           → Frontend 2302 (React App + built-in API proxy)

server {
    listen 4000;
    server_name _;

    # Max upload size
    client_max_body_size 50M;

    # ── Gateway Admin UI via /gateway/ prefix ──
    # Access admin at: https://xxxx.ngrok-free.app/gateway/
    location /gateway/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Rewrite redirects from gateway
        proxy_redirect / /gateway/;

        # Sub-filter to fix asset paths in HTML
        sub_filter_once off;
        sub_filter_types application/javascript;
        sub_filter 'href="/' 'href="/gateway/';
        sub_filter "href='/" "href='/gateway/";
        sub_filter 'src="/' 'src="/gateway/';
        sub_filter "src='/" "src='/gateway/";
        sub_filter 'action="/' 'action="/gateway/';
    }

    # ── Direct Gateway API paths ──
    location /management/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /v3/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /swagger-ui/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── Everything else → Frontend (port 2302) ──
    # The frontend container has its own nginx that handles:
    #   /services/*  → gateway:8080 (via Docker internal network)
    #   /yahoo-api/* → Yahoo Finance API
    #   /*           → React SPA
    location / {
        proxy_pass http://localhost:2302;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
